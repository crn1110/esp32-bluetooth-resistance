<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ESP32蓝牙实时电阻测量系统</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      padding: 0;
      text-align: center;
      -webkit-text-size-adjust: 100%;
    }
    
    h1 {
      font-size: 1.5rem;
      margin-bottom: 20px;
      color: #333;
    }
    
    .button-container {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    button {
      padding: 12px 24px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      min-width: 150px;
      transition: all 0.3s;
    }
    
    #connectButton {
      background-color: #4CAF50;
      color: white;
    }
    
    #disconnectButton {
      background-color: #ff4444;
      color: white;
    }
    
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
      opacity: 0.7;
    }
    
    .data-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin: 20px 0;
    }
    
    .data-panel {
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 8px;
      background-color: #f9f9f9;
    }
    
    .data-panel h3 {
      font-size: 1rem;
      margin-bottom: 10px;
      color: #555;
    }
    
    #resistance, #maxResistance, #minResistance {
      font-size: 1.5rem;
      font-weight: bold;
      color: #007BFF;
    }
    
    .chart-container {
      width: 100%;
      margin: 20px auto;
      padding: 10px;
      border: 1px solid #eee;
      border-radius: 8px;
      background-color: #fff;
    }
    
    .info-panel {
      margin: 15px;
      padding: 15px;
      border-radius: 5px;
      font-size: 0.9rem;
      text-align: left;
    }
    
    #mobileTips {
      background-color: #fff9e6;
      color: #666;
      display: none;
    }
    
    #iosTips {
      background-color: #e6f3ff;
      color: #0066cc;
      display: none;
    }
    
    #androidEdgeTip {
      background-color: #e8f5e9;
      color: #2e7d32;
      display: none;
    }
    
    #errorMessage {
      background-color: #ffebee;
      color: #c62828;
      display: none;
    }
    
    /* 平板和桌面布局 */
    @media (min-width: 768px) {
      body {
        margin: 30px;
      }
      
      h1 {
        font-size: 2rem;
      }
      
      .data-container {
        flex-direction: row;
        justify-content: center;
        gap: 30px;
      }
      
      .data-panel {
        min-width: 180px;
      }
      
      .chart-container {
        width: 90%;
        max-width: 1000px;
      }
    }
  </style>
  <!-- 引入Chart.js库 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <h1>ESP32蓝牙实时电阻测量系统</h1>

  <div id="mobileTips" class="info-panel">
    <strong>移动端使用提示：</strong>请确保蓝牙已开启，并授予浏览器蓝牙权限。Android设备需要开启位置服务才能使用蓝牙功能。
  </div>
  
  <div id="iosTips" class="info-panel">
    <strong>iOS用户提示：</strong>苹果设备需要安装支持Web Bluetooth的浏览器(如Bluefy)才能连接ESP32设备。<br>
    <a href="https://apps.apple.com/us/app/bluefy-web-ble-browser/id1492822055" target="_blank" style="color: #0066cc; text-decoration: underline;">点击下载Bluefy浏览器</a>
  </div>
  
  <div id="androidEdgeTip" class="info-panel">
    <strong>浏览器兼容性提示：</strong>请使用Microsoft Edge浏览器访问本系统。如果您没有安装Edge浏览器，请到手机应用商店搜索"Microsoft Edge"进行下载。<br><br>
    <strong>注意：</strong>Chrome、Edge和Firefox浏览器均可正常使用，如果您正在使用这些浏览器但仍看到此提示，请忽略。
  </div>
  
  <div id="errorMessage" class="info-panel"></div>

  <div class="button-container">
    <button id="connectButton">连接ESP32蓝牙设备</button>
    <button id="disconnectButton" disabled>断开连接</button>
  </div>

  <div class="data-container">
    <div class="data-panel">
      <h3>当前电阻值</h3>
      <div id="resistance">-- Ω</div>
    </div>
    <div class="data-panel">
      <h3>最大电阻值</h3>
      <div id="maxResistance">-- Ω</div>
    </div>
    <div class="data-panel">
      <h3>最小电阻值</h3>
      <div id="minResistance">-- Ω</div>
    </div>
  </div>

  <div class="chart-container">
    <canvas id="resistanceChart"></canvas>
  </div>

  <script>
    // 全局变量
    let bluetoothDevice = null;
    let characteristic = null;
    const connectButton = document.getElementById('connectButton');
    const disconnectButton = document.getElementById('disconnectButton');
    const resistanceSpan = document.getElementById('resistance');
    const maxResistanceSpan = document.getElementById('maxResistance');
    const minResistanceSpan = document.getElementById('minResistance');
    const mobileTips = document.getElementById('mobileTips');
    const iosTips = document.getElementById('iosTips');
    const androidEdgeTip = document.getElementById('androidEdgeTip');
    const errorMessage = document.getElementById('errorMessage');
    
    // 图表相关变量
    let resistanceChart;
    let chartData = {
      labels: [],  // 时间轴
      datasets: [{
        label: '电阻值 (Ω)',
        data: [],
        borderColor: 'rgb(75, 192, 192)',
        backgroundColor: 'rgba(75, 192, 192, 0.1)',
        tension: 0.1,
        fill: true
      }]
    };
    
    // 数据统计
    let maxResistance = -Infinity;
    let minResistance = Infinity;
    let startTime = null;
    
    // 检测设备和浏览器兼容性
    function checkDeviceCompatibility() {
      const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
      const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
      const isAndroid = /Android/i.test(navigator.userAgent);
      const isEdge = /Edg/i.test(navigator.userAgent);
      const isChrome = /Chrome/i.test(navigator.userAgent);
      const isFirefox = /Firefox/i.test(navigator.userAgent);
      
      // 显示移动端提示
      if (isMobile) {
        mobileTips.style.display = 'block';
      }
      
      // 显示平台特定提示
      if (isIOS) {
        iosTips.style.display = 'block';
      } else if (isAndroid && !isEdge && !isChrome && !isFirefox) {
        // 仅当Android用户使用非推荐浏览器时显示Edge提示
        androidEdgeTip.style.display = 'block';
      }
      
      // 检查Web Bluetooth支持
      if (!navigator.bluetooth) {
        if (isIOS) {
          showError('iOS设备需要使用支持Web Bluetooth的浏览器(如Bluefy)');
          connectButton.disabled = true;
        } else if (isAndroid) {
          showError('当前浏览器不支持蓝牙功能，请使用Edge、Chrome或Firefox浏览器');
          connectButton.disabled = true;
        } else {
          showError('您的浏览器不支持Web Bluetooth功能');
          connectButton.disabled = true;
        }
        return false;
      }
      
      return true;
    }
    
    // 显示错误信息
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
    }
    
    // 隐藏错误信息
    function hideError() {
      errorMessage.style.display = 'none';
    }
    
    // 初始化图表
    function initChart() {
      const ctx = document.getElementById('resistanceChart').getContext('2d');
      resistanceChart = new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            x: {
              title: {
                display: true,
                text: '时间 (秒)',
                font: {
                  size: 14
                }
              },
              ticks: {
                maxRotation: 45,
                minRotation: 45
              }
            },
            y: {
              title: {
                display: true,
                text: '电阻值 (Ω)',
                font: {
                  size: 14
                }
              }
            }
          },
          plugins: {
            legend: {
              labels: {
                font: {
                  size: 14
                }
              }
            }
          }
        }
      });
    }
    
    // 连接函数
    async function connectToESP32() {
      if (!checkDeviceCompatibility()) return;
      
      try {
        connectButton.disabled = true;
        disconnectButton.disabled = false;
        hideError();
        
        // 重置数据和图表
        resetData();
        
        // 请求蓝牙设备
        bluetoothDevice = await navigator.bluetooth.requestDevice({
          filters: [{ 
            name: 'ESP32_StrainGauge',
            services: ['00001234-0000-1000-8000-00805f9b34fb']
          }],
          optionalServices: ['00001234-0000-1000-8000-00805f9b34fb']
        });

        bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);
        
        // 连接GATT服务器
        const server = await bluetoothDevice.gatt.connect();
        const service = await server.getPrimaryService('00001234-0000-1000-8000-00805f9b34fb');
        characteristic = await service.getCharacteristic('00004321-0000-1000-8000-00805f9b34fb');
        
        // 开始通知
        await characteristic.startNotifications();
        characteristic.addEventListener('characteristicvaluechanged', updateResistanceValue);
        
        connectButton.textContent = '已连接';
        startTime = Date.now();
      } catch (error) {
        console.error('连接失败:', error);
        onDisconnected();
        
        // 特定错误处理
        let errorMsg = '连接失败: ' + error.message;
        
        if (error.message.includes('not found')) {
          errorMsg = '未找到ESP32设备，请确保设备已开启蓝牙并处于可发现模式';
        } else if (error.message.includes('permission')) {
          errorMsg = '请授予浏览器蓝牙访问权限';
        } else if (error.message.includes('location')) {
          errorMsg = 'Android设备需要开启位置服务才能使用蓝牙功能';
        } else if (error.message.includes('User cancelled')) {
          errorMsg = '用户取消了设备选择';
        } else if (error.message.includes('GATT Server is disconnected')) {
          errorMsg = '蓝牙连接已断开，请重试';
        }
        
        showError(errorMsg);
      }
    }

    // 断开函数
    function disconnectFromESP32() {
      if (!bluetoothDevice) return;
      
      try {
        if (bluetoothDevice.gatt.connected) {
          bluetoothDevice.gatt.disconnect();
        }
      } catch (error) {
        console.error('断开失败:', error);
        showError('断开失败: ' + error.message);
      } finally {
        onDisconnected();
      }
    }

    // 断开后的清理
    function onDisconnected() {
      if (characteristic) {
        characteristic.removeEventListener('characteristicvaluechanged', updateResistanceValue);
        characteristic = null;
      }
      
      if (bluetoothDevice) {
        bluetoothDevice.removeEventListener('gattserverdisconnected', onDisconnected);
        bluetoothDevice = null;
      }
      
      connectButton.disabled = false;
      disconnectButton.disabled = true;
      connectButton.textContent = '连接ESP32蓝牙设备';
      resistanceSpan.textContent = '-- Ω';
      maxResistanceSpan.textContent = '-- Ω';
      minResistanceSpan.textContent = '-- Ω';
    }

    // 重置数据
    function resetData() {
      chartData.labels = [];
      chartData.datasets[0].data = [];
      if (resistanceChart) {
        resistanceChart.update();
      }
      maxResistance = -Infinity;
      minResistance = Infinity;
      startTime = null;
    }
    
    // 数据更新函数
    function updateResistanceValue(event) {
      const valueStr = new TextDecoder().decode(event.target.value);
      const value = parseFloat(valueStr);
      
      if (isNaN(value)) return;
      
      // 更新当前值显示
      resistanceSpan.textContent = value.toFixed(2) + ' Ω';
      
      // 更新时间
      const currentTime = (Date.now() - startTime) / 1000; // 转换为秒
      
      // 更新统计数据
      if (value > maxResistance) {
        maxResistance = value;
        maxResistanceSpan.textContent = value.toFixed(2) + ' Ω';
      }
      if (value < minResistance) {
        minResistance = value;
        minResistanceSpan.textContent = value.toFixed(2) + ' Ω';
      }
      
      // 添加到图表数据
      chartData.labels.push(currentTime.toFixed(1));
      chartData.datasets[0].data.push(value);
      
      // 限制数据点数量以避免性能问题
      const maxDataPoints = 100;
      if (chartData.labels.length > maxDataPoints) {
        chartData.labels.shift();
        chartData.datasets[0].data.shift();
      }
      
      // 更新图表
      resistanceChart.update();
    }

    // 初始化
    function initializeApp() {
      initChart();
      checkDeviceCompatibility();
    }

    // 事件绑定
    document.addEventListener('DOMContentLoaded', initializeApp);
    connectButton.addEventListener('click', connectToESP32);
    disconnectButton.addEventListener('click', disconnectFromESP32);
  </script>

</body>
</html>